const express = require('express');
const multer = require('multer');
require('dotenv').config();
const path = require('path');
const bodyParser = require('body-parser');
const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));


const query = require('./db.js');//Database connection



//---File Upload segment-----
app.post('/upload', upload.single('file'), (req, res) => {
    console.log(req);
    if(!req.file) {res.end({success:false, message:"Param name must be 'file'"}); return;}
    let file = req.file;
    if(!file) {
	res.json({ success:false, message:"Please upload a file!"});
	res.end();
	return;
	} 
	res.json({success: true, message:"Successfully received image as ./images/" + file.originalname}); 
	res.end();
	});


app.get('/sql', async (request, response) => {
   try{
	 console.log(request.headers);
    	console.log(request.query);
    	console.log('----');
	let item = await query(request.query.query).catch((err)=>{
			response.end({success: false, payload: err}); 
			return;
		});
	console.log(item);
	console.log('--------');
	response.json({success: true, payload: item});
	response.end();
	return;	
    }
    catch (err){ 
	response.json({success: false, payload: err}); 
	response.end();
	return; 
	}
    response.json({success: false, message:"Somehow the try catch got skipped?!"});
    response.end();
});

app.use('/images', express.static(__dirname + '/images'));
app.use('/', express.static(__dirname + '/Campus360-JS'));


app.listen(3000, ()=>{console.log("Listening on 3000")});
